#!/usr/bin/env bash
set -e
dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)

PATH="$dir/../:$PATH"
. util

dir_dist="$dir/dist"
rm -rf "$dir_dist" && mkdir -p "$dir_dist"

for path_dir_src_document in $dir/documents/generic/*/; do
  echo "Building document $(basename $path_dir_src_document)"

  path_file_document_path="$path_dir_src_document/values/tparts_inline_path"
  if [ ! -f $path_file_document_path ]; then echo "$path_file_document_path is missing. Exiting."; exit 1; fi

  path_dir_dist_document="$dir_dist/$(cat $path_file_document_path)"
  mkdir -p "$path_dir_dist_document"

  cp -r $path_dir_src_document/static/* "$path_dir_dist_document"

  path_file_values_paths="$dir_dist/$(cat $path_file_document_path)/values_paths"

  resolve_values_paths "$dir/values/generic" "$path_dir_src_document/values" >> "$path_file_values_paths"

  awk \
    -f "$dir/../build_document.awk" \
    -v filename_value_entrypoint="tparts_block_document.html" \
    -v path_values_index="$path_file_values_paths" \
    > "$path_dir_dist_document/index.html"

  rm "$dir_dist/$(cat $path_file_document_path)/values_paths"

  echo "Document $(basename $path_dir_src_document) has been built
  "
done

echo "All documents have been built in
$dir_dist"
