#!/usr/bin/env bash
set -e
dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
PATH="$dir/../:$PATH"; . util
dir_dist="$dir/dist"; rm -rf "$dir_dist" && mkdir -p "$dir_dist"

function build_sitemap() {
  echo "Building sitemap
  "

  echo "Sitemap has been built
  "
}

function build_generic_documents() {
  path_dir_src_documents=$dir/documents/
  echo "Building generic documents from $path_dir_src_documents
  "

  for path_dir_src_document in $path_dir_src_documents/*/; do
    echo "Building document $path_dir_src_document"

    path_file_document_url_path="$dir/values/_inline_path"
    if [[ -f "$path_dir_src_document/_inline_path" ]]; then path_file_document_url_path="$path_dir_src_document/_inline_path"; fi

    path_file_document_filename="$dir/values/_inline_filename"
    if [[ -f "$path_dir_src_document/_inline_filename" ]]; then path_file_document_filename="$path_dir_src_document/_inline_filename"; fi

    document_url_path=$(cat "$path_file_document_url_path")
    document_filename=$(cat "$path_file_document_filename")

    echo "Server path: $document_url_path/$document_filename"

    path_dir_dist_document="$dir_dist/$document_url_path"
    path_file_values_index="$dir_dist/$document_url_path/values_paths"

    mkdir -p "$path_dir_dist_document"

    if [ -d $path_dir_src_document/static/ ]; then cp -r $path_dir_src_document/static/* "$path_dir_dist_document"; fi 

    resolve_values_paths "$dir/values/" "$path_dir_src_document" >> "$path_file_values_index"

    awk -f "$dir/../build_document.awk" -v path_values_index="$path_file_values_index" > "$path_dir_dist_document/$document_filename"

    rm "$path_file_values_index"

    echo "Document $(basename $path_dir_src_document) has been built
    "
  done

  echo "Generic documents have been built
  "
}

build_generic_documents
build_sitemap

echo "All documents have been built in
$dir_dist"
